{% extends 'dashboardd/base.html' %}

{% block title %}{{ property.name }} - Units - Maghettoni{% endblock %}
{% block page_title %}{{ property.name }} Units{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{% url 'property_detail' property.id %}" class="inline-flex items-center text-landlord-primary hover:text-brown-800 font-medium transition-colors hover-lift">
        <i class="fas fa-arrow-left mr-2"></i> Back to Property
    </a>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-2xl p-5 border border-brown-200 shadow-lg glass hover-lift">
        <div class="flex items-center">
            <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-door-open text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-600">Total Units</h4>
                <p class="text-2xl font-bold text-gray-900">{{ total_units }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-2xl p-5 border border-brown-200 shadow-lg glass hover-lift">
        <div class="flex items-center">
            <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-users text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-600">Occupied</h4>
                <p class="text-2xl font-bold text-gray-900">{{ occupied_units }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-2xl p-5 border border-brown-200 shadow-lg glass hover-lift">
        <div class="flex items-center">
            <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-bed text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-600">Vacant</h4>
                <p class="text-2xl font-bold text-gray-900">{{ vacant_units }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-2xl p-5 border border-brown-200 shadow-lg glass hover-lift">
        <div class="flex items-center">
            <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center">
                <i class="fas fa-money-bill-wave text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h4 class="text-sm font-medium text-gray-600">Monthly Revenue</h4>
                <p class="text-2xl font-bold text-gray-900">${{ total_monthly_rent|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<div class="bg-white rounded-2xl shadow-xl border border-brown-200 overflow-hidden glass card-shine">
    <!-- Card Header -->
    <div class="px-8 py-6 border-b border-brown-100 bg-gradient-to-r from-brown-50 to-white">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-brown-600 to-brown-700 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-building text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-landlord-dark font-display">Unit Management</h3>
                    <p class="text-brown-600 mt-1">{{ property.name }} â€¢ {{ property.address|truncatechars:30 }}</p>
                </div>
            </div>
            <a href="{% url 'unit_add' property.id %}" 
               class="mt-4 sm:mt-0 inline-flex items-center px-6 py-3 bg-gradient-to-r from-brown-600 to-brown-700 text-white rounded-xl hover:from-brown-700 hover:to-brown-800 transition-all font-medium shadow-lg hover:shadow-xl hover-lift">
                <i class="fas fa-plus mr-2"></i>
                Add New Unit
            </a>
        </div>
    </div>

    <!-- Units Table -->
    <div class="overflow-x-auto">
        {% if units %}
        <table class="min-w-full divide-y divide-brown-100">
            <thead class="bg-brown-50">
                <tr>
                    <th scope="col" class="px-8 py-4 text-left text-xs font-semibold text-brown-800 uppercase tracking-wider font-display">
                        <i class="fas fa-hashtag mr-2"></i>
                        Unit Details
                    </th>
                    <th scope="col" class="px-8 py-4 text-left text-xs font-semibold text-brown-800 uppercase tracking-wider font-display">
                        <i class="fas fa-expand-arrows-alt mr-2"></i>
                        Specifications
                    </th>
                    <th scope="col" class="px-8 py-4 text-left text-xs font-semibold text-brown-800 uppercase tracking-wider font-display">
                        <i class="fas fa-money-bill-wave mr-2"></i>
                        Rent & Status
                    </th>
                    <th scope="col" class="px-8 py-4 text-left text-xs font-semibold text-brown-800 uppercase tracking-wider font-display">
                        <i class="fas fa-cogs mr-2"></i>
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-brown-100">
                {% for unit in units %}
                <tr class="hover:bg-brown-50 transition-all duration-300 group">
                    <td class="px-8 py-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-12 h-12 rounded-xl flex items-center justify-center 
                                {% if unit.is_occupied %}bg-green-100 text-green-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                <i class="fas fa-door-closed text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-lg font-bold text-gray-900 font-display">Unit {{ unit.unit_number }}</h4>
                                <p class="text-sm text-brown-600 flex items-center mt-1">
                                    <i class="fas fa-home mr-1"></i>
                                    {{ unit.property.name }}
                                </p>
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-5">
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 border border-blue-200">
                                    <i class="fas fa-bed mr-1.5"></i>
                                    {{ unit.bedrooms }} bed{{ unit.bedrooms|pluralize }}
                                </span>
                                <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-medium bg-green-50 text-green-700 border border-green-200 ml-2">
                                    <i class="fas fa-bath mr-1.5"></i>
                                    {{ unit.bathrooms }} bath{{ unit.bathrooms|pluralize }}
                                </span>
                            </div>
                            {% if unit.square_feet %}
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-ruler-combined mr-1"></i>
                                {{ unit.square_feet }} sqft
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-8 py-5">
                        <div class="space-y-3">
                            <div>
                                <p class="text-xl font-bold text-gray-900">${{ unit.monthly_rent }}</p>
                                <p class="text-xs text-gray-500">monthly rent</p>
                            </div>
                            <div>
                                {% if unit.is_occupied %}
                                <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-green-100 text-green-800 border border-green-300">
                                    <i class="fas fa-user-check mr-1.5"></i>
                                    Occupied
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-yellow-100 text-yellow-800 border border-yellow-300">
                                    <i class="fas fa-bed mr-1.5"></i>
                                    Vacant
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-8 py-5">
                        <div class="flex items-center space-x-3">
                            <a href="{% url 'unit_edit' property.id unit.id %}" 
                               class="inline-flex items-center px-4 py-2 border border-brown-300 text-brown-700 bg-white rounded-xl hover:bg-brown-50 transition-all font-medium hover-lift">
                                <i class="fas fa-edit mr-2"></i>
                                Edit
                            </a>
                            
                            {% if unit.is_occupied %}
                            <span class="inline-flex items-center px-3 py-2 text-sm text-gray-400 cursor-not-allowed">
                                <i class="fas fa-user-times mr-1"></i>
                                Occupied
                            </span>
                            {% else %}
                            <a href="{% url 'add_tenant' %}" 
                               class="inline-flex items-center px-4 py-2 border border-transparent text-white bg-green-600 rounded-xl hover:bg-green-700 transition-all font-medium hover-lift">
                                <i class="fas fa-user-plus mr-2"></i>
                                Add Tenant
                            </a>
                            {% endif %}
                            
                            <!-- Dropdown Menu -->
                            <div class="relative group">
                                <button class="p-2 text-gray-400 hover:text-brown-600 rounded-lg hover:bg-brown-100 transition-all">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-2xl border border-brown-200 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
                                    <div class="py-1">
                                        <a href="#" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-brown-50 hover:text-brown-700 transition-all">
                                            <i class="fas fa-file-invoice-dollar mr-3 text-brown-600"></i>
                                            View Payments
                                        </a>
                                        <a href="#" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-brown-50 hover:text-brown-700 transition-all">
                                            <i class="fas fa-tools mr-3 text-brown-600"></i>
                                            Maintenance
                                        </a>
                                        <div class="border-t border-brown-100 my-1"></div>
                                        {% if not unit.is_occupied %}
                                        <form method="POST" action="{% url 'unit_delete' property.id unit.id %}" class="inline">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    onclick="return confirm('Are you sure you want to delete Unit {{ unit.unit_number }}?')"
                                                    class="flex items-center w-full px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-all">
                                                <i class="fas fa-trash-alt mr-3"></i>
                                                Delete Unit
                                            </button>
                                        </form>
                                        {% else %}
                                        <span class="flex items-center px-4 py-3 text-sm text-gray-400 cursor-not-allowed">
                                            <i class="fas fa-trash-alt mr-3"></i>
                                            Cannot delete (occupied)
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                
                <!-- Description Row (Collapsible) -->
                {% if unit.description %}
                <tr class="bg-brown-50/50">
                    <td colspan="4" class="px-8 py-4">
                        <div class="flex items-start">
                            <i class="fas fa-sticky-note text-brown-400 mt-1 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Description</p>
                                <p class="text-sm text-gray-600">{{ unit.description }}</p>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="mx-auto w-24 h-24 bg-gradient-to-br from-brown-100 to-brown-200 rounded-2xl flex items-center justify-center mb-6 shadow-lg">
                <i class="fas fa-door-closed text-brown-600 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 font-display mb-3">No units yet</h3>
            <p class="text-brown-600 max-w-md mx-auto mb-8">
                Start by adding units to this property. Each unit can have different specifications and rent amounts.
            </p>
            <a href="{% url 'unit_add' property.id %}" 
               class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-brown-600 to-brown-700 text-white rounded-xl hover:from-brown-700 hover:to-brown-800 transition-all font-medium shadow-lg hover:shadow-xl hover-lift text-lg">
                <i class="fas fa-plus mr-2"></i>
                Add Your First Unit
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bulk Actions Card -->
{% if units %}
<div class="mt-8 bg-white rounded-2xl shadow-lg border border-brown-200 overflow-hidden glass">
    <div class="px-8 py-6 border-b border-brown-100 bg-gradient-to-r from-blue-50 to-white">
        <h3 class="text-xl font-bold text-landlord-dark font-display">Bulk Actions</h3>
    </div>
    <div class="p-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 border border-brown-200 rounded-xl hover:bg-brown-50 transition-all cursor-pointer hover-lift">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-file-export text-blue-600"></i>
                    </div>
                    <h4 class="text-sm font-semibold text-gray-900">Export Units</h4>
                </div>
                <p class="text-xs text-gray-600">Download unit list as CSV or PDF</p>
            </div>
            <div class="p-4 border border-brown-200 rounded-xl hover:bg-brown-50 transition-all cursor-pointer hover-lift">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-chart-bar text-green-600"></i>
                    </div>
                    <h4 class="text-sm font-semibold text-gray-900">Rent Analysis</h4>
                </div>
                <p class="text-xs text-gray-600">Compare rent prices and occupancy</p>
            </div>
            <div class="p-4 border border-brown-200 rounded-xl hover:bg-brown-50 transition-all cursor-pointer hover-lift">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-bell text-purple-600"></i>
                    </div>
                    <h4 class="text-sm font-semibold text-gray-900">Vacancy Alerts</h4>
                </div>
                <p class="text-xs text-gray-600">Get notified when units become vacant</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Toggle description visibility
document.addEventListener('DOMContentLoaded', function() {
    const unitRows = document.querySelectorAll('tr.hover\\:bg-brown-50');
    unitRows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('a') && !e.target.closest('button') && !e.target.closest('form')) {
                const descriptionRow = this.nextElementSibling;
                if (descriptionRow && descriptionRow.classList.contains('bg-brown-50/50')) {
                    descriptionRow.classList.toggle('hidden');
                }
            }
        });
    });
});

// Quick filter functionality
function filterUnits(status) {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        if (row.classList.contains('hover:bg-brown-50')) {
            const statusSpan = row.querySelector('span');
            if (status === 'all' || 
                (status === 'occupied' && statusSpan?.textContent.includes('Occupied')) ||
                (status === 'vacant' && statusSpan?.textContent.includes('Vacant'))) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        }
    });
}

// Confetti on successful actions
document.addEventListener('DOMContentLoaded', function() {
    const successMessages = document.querySelectorAll('[class*="success"]');
    if (successMessages.length > 0) {
        setTimeout(() => {
            createConfetti();
        }, 500);
    }
});

// Confetti function
function createConfetti() {
    const colors = ['#603b2b', '#8b6e5e', '#d4a574', '#f8f3e6'];
    for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 8px;
            height: 8px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            z-index: 9999;
            pointer-events: none;
            left: ${Math.random() * 100}vw;
            top: -20px;
            animation: fall ${Math.random() * 2 + 1}s linear forwards;
        `;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2000);
    }
}
</script>
{% endblock %}